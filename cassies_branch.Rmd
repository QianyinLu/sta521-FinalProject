---
title: "Part-I Simple Model"
author: "Chenxi Wu"
geometry: margin=1in
date: "11/30/2019"
output: 
    pdf_document:
        highlight: pygment
        toc: false
        toc_depth: 2
        fig_caption: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo=FALSE, 

                      warning=FALSE, 

                      message=FALSE,

                      fig.align="center",

                      fig.pos='H', 

                      results="asis")

```



```{r pakages}

library(tidyverse)

library(knitr)

library(gbm)

library(xtable)

library(kableExtra)

library(broom)

library(car)

```



```{r read-data}

load("paintings_train.Rdata")

load("paintings_test.Rdata")

```



## Introduction



## EDA



```{r data-manipulation}

# merge the two dataset first

paint <- rbind(paintings_train, paintings_test)



# Fix position > 1

paint$position[paintings_train$position > 1] <- paint$position[paint$position > 1]/100



# Fix material type

paint$material[str_detect(paint$material, "^bois")] <- "bois"

paint$material[str_detect(paint$material, "^cuivre")] <- "cuivre"

paint$material[str_detect(paint$material, "^tableau")] <- "tableau"

paint$material[str_detect(paint$material, "^toile")] <- "toile"







# regroup some categorical variables

paint <- paint %>%

  mutate(winningbiddertype = as.factor(dplyr::recode(na_if(winningbiddertype,""),

                                              .missing = 'U')),

         endbuyer = as.factor(dplyr::recode(na_if(endbuyer,''),

                                     .missing = 'U')),

         Interm = as.factor(dplyr::recode(Interm,

                                   .missing = 0,

                                   `0` = 0,

                                   `1` = 1)),

         type_intermed = as.factor(dplyr::recode(na_if(type_intermed,''),

                                          .missing='Unknown')),

         Shape = as.factor(dplyr::recode(na_if(Shape,""),

                                  .missing = 'unknown',

                                  'squ_rect' = 'squ_rect',

                                  .default = 'other')),

         materialCat = as.factor(dplyr::recode(na_if(materialCat,""),

                                        .missing = 'unknown')),

         material = as.factor(dplyr::recode(na_if(material,""),

                                     .missing = 'unknown',

                                     'n/a' = 'unknown', 

                                     'bois' = 'bois', 

                                     'cuivre' = 'cuivre', 

                                     'tableau' = 'tableau', 

                                     'toile' = 'toile', 

                                     .default = 'other')), 

         mat = as.factor(dplyr::recode(na_if(mat,""),

                                     .missing = 'unknown',

                                     'n/a' = 'unknown', 

                                     'b'='wood', 

                                     'c'='copper',

                                     'o'='other', 

                                     't'='canvas', 

                                     'ta'='canvas',  

                                     .default = 'other'))

         ) %>% 

  # change variables into appropriate format

  mutate_at(vars(dealer, origin_author, origin_cat, school_pntg, 

                 diff_origin, artistliving, authorstandard, authorstyle, 

                 winningbiddertype, endbuyer, Interm, type_intermed, 

                 material, mat, materialCat, Shape, engraved, original, 

                 prevcoll, othartist, paired, figures, finished, lrgfont, 

                 relig, landsALL, lands_sc, lands_elem, lands_figs, lands_ment, 

                 arch, mytho, peasant, othgenre, singlefig, portrait, 

                 still_life, discauth, history, allegory, pastorale), as.factor) %>% 

  mutate_at(vars(price), as.numeric)



# delete unnecessary variables

paint <- paint %>% 

  dplyr::select(-c(sale, lot, count, subject, author, authorstandard, winningbidder))



#summary(paint)



paint_train <- paint[1:1500, ]

paint_test <- paint[1501:2250, ]

```



```{r eda}

hist1 <- ggplot(paint_train, aes(x = logprice)) +

  geom_histogram(fill = "light blue") +

  labs(title = "Empirical distribution for `logprice`")

hist2 <- ggplot(paint_train, aes(x = price)) +

  geom_histogram(fill = "light blue") +

  labs(title = "Empirical distribution for `price`")

grid.arrange(hist1, hist2, ncol = 2)



# create dataframe for eda plots

eda_cat <- cbind(logprice = paint_train$logprice, 

                 paint_train[, map_chr(paint_train, class) == "factor"])

eda_con <- paint_train[, map_chr(paint_train, class) == "numeric" |
                         map_chr(paint_train, class) == "integer"] %>% 
  dplyr::select(c(3, 4, 1 ,2, 3))

  dplyr::select(c(3, 1:2, 6:13))

eda_cat <- eda_cat %>% 

  gather(key = "categorical", value = "value", dealer:pastorale)

eda_con <- eda_con %>% 

  gather(key = "numeric", value  ="value", position:other)



# split eda_cat since there are too many variables

eda_cat1 <- eda_cat[c(1:30000), ]

eda_cat2 <- eda_cat[c(30001:60000), ]



ggplot(eda_cat1, aes(x = value, y = logprice, colour = categorical)) +

  geom_boxplot(show.legend = F) +

  facet_wrap(~categorical, scales = "free") +

  labs(x = "", title = "logprice vs categorical predictors") +

  theme_bw()



ggplot(eda_cat2, aes(x = value, y = logprice, colour = categorical)) +

  geom_boxplot(show.legend = F) +

  facet_wrap(~categorical, scales = "free") +

  labs(x = "", title = "logprice vs categorical predictors") +

  theme_bw()



ggplot(eda_con, aes(x = value, y = logprice)) +

  geom_point(size = 0.5, alpha = 0.5) +

  stat_smooth(method = "lm") +

  facet_wrap(~numeric, scales = "free") +

  labs(x = "", title = "logprice vs categorical predictors") +

  theme_bw()

```

To start with, we first check on the emprirical distribution of the response variable. There are 2 variables, *logprice* and *price*. From the histogram, we can see that *logprice*, which is the logarithm of *price*, is more normally-distributed. Consider the normality assumption of linear regression, we will use *logprice* as the response variable.  

  

```{r chi}

tab_ori <- table(paint_train$origin_author, paint_train$origin_cat)

kable(tab_ori)

chi1 <- chisq.test(tab_ori)

tab_material <- table(paint_train$material, paint_train$materialCat)

chi2 <- chisq.test(tab_material)

tab_mat <- table(paint_train$mat, paint_train$materialCat)

chi3 <- chisq.test(tab_mat)

```

  

Then we plot *logprice* against all continuous and categorical variables respectively. Here are some findings.     

  

For categorical variables: 

 

 - *history*, *original*, *type_intermed*, *Shape* and *pastorale* have serious **class imbalance** problem, where certain value is seldomly observed. So we will discard these variables in modeling.    

 - The variable *authorstyle* contains too many NA's which is not sufficient to do any analysis, which will also be discarded.  

 - After cleaning the data, *mat*, *material* and *materialCat* record duplicate features. We will only keep *mat* in future analysis since it contains all the information in the other two.  

 - *origin_author* and *origin_cat* record similar features which is suspecious of highly dependent on each other. We implement Chi-squared test to test the hypothesis, which yield a p-value of `r chi$p.value`. Thus we will only keep *origin_cat* since it contains less levels.  

 - At glance, strong predictors includde *dealer*, *diff_origin*, *discauth*, *endbuyer*, *materialCat*, *interm*, *finished*, *engraved*, *figures*, *Irgfont*, *origin_cat*, *paired*, *portrait*, *prevcoll*, *lands_sc*, *lands_elem*.  





  

For continuous variables: 

 

 - *other* and *position* have most of their values gather around 0 and we cannot observe any obvious pattern.  

 - *Diam-in* and *Surface_Rnd* contain too many NA's and therefore should not be inlcuded in the model.  

 - *Surface*, *Surface_Rnd* and *Surface_Rect* contain duplicate information, and *Surface* contains all the information in *Surface_Rect*. So we will only keep *Surface*. *Height_in* and *Width_in* are discarded for similar reasoning.  

 - *nfigures* might need transformations, so I will exponentiate it in the model. 



 

 

```{r ggpairs}

paint2 <- paint %>% 

  dplyr::select(-c(price, origin_author, authorstyle, material, materialCat, history, original, pastorale, other))

paint_train2 <- paint2[1:1500, ]

paint_test2 <- paint2[1501:2250, ]

ggpairs(paint_train2, columns = c(7, 1:6), 

        lower = list(continuous = wrap("points", alpha = 0.5, size = 0.3)))+

  theme(axis.text = element_text(angle = 45, hjust = 1))

ggpairs(paint_train2, columns = c(7, 8:13), 

        lower = list(continuous = wrap("points", alpha = 0.5, size = 0.3)))+

  theme(axis.text = element_text(angle = 45, hjust = 1))

ggpairs(paint_train2, columns = c(7, 14:19), 

        lower = list(continuous = wrap("points", alpha = 0.5, size = 0.3)))+

  theme(axis.text = element_text(angle = 45, hjust = 1))

ggpairs(paint_train2, columns = c(7, 20:25), 

        lower = list(continuous = wrap("points", alpha = 0.5, size = 0.3)))+

  theme(axis.text = element_text(angle = 45, hjust = 1))

ggpairs(paint_train2, columns = c(7, 26:31), 

        lower = list(continuous = wrap("points", alpha = 0.5, size = 0.3)))+

  theme(axis.text = element_text(angle = 45, hjust = 1))

ggpairs(paint_train2, columns = c(7, 32:37), 

        lower = list(continuous = wrap("points", alpha = 0.5, size = 0.3)))+

  theme(axis.text = element_text(angle = 45, hjust = 1))

ggpairs(paint_train2, columns = c(7, 38:43), 

        lower = list(continuous = wrap("points", alpha = 0.5, size = 0.3)))+

  theme(axis.text = element_text(angle = 45, hjust = 1))

```

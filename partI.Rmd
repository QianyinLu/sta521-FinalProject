---
title: "Part I"
output: html_notebook
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(tidyverse)
library(GGally)
library(car)
library(dplyr)
```

```{r read data}
load("paintings_train.Rdata")
load("paintings_test.Rdata")
```

### Data cleaning 

```{r data-manipulation}
# merge the two dataset first
paint <- rbind(paintings_train, paintings_test)
# Fix position > 1
paint$position[paint$position > 1] <- paint$position[paint$position > 1]/100
# regroup some categorical variables
paint <- paint %>%
  mutate(winningbiddertype = as.factor(dplyr::recode(na_if(winningbiddertype,""),
                                              .missing = 'U')),
         endbuyer = as.factor(dplyr::recode(na_if(endbuyer,""),
                                     .missing = 'U')),
         Interm = as.factor(dplyr::recode(Interm,
                                   .missing = 0,
                                  `0` = 0,
                                 `1` = 1)), 
         authorstyle = as.factor(dplyr::recode(authorstyle,
                                               'n/a' = 0,
                                               .default = 1)),
         type_intermed = as.factor(dplyr::recode(na_if(type_intermed,''),
                                          .missing='Unknown')),
         Shape = as.factor(dplyr::recode(na_if(Shape,""),
                                  .missing = 'Unknown',
                                  'squ_rect' = 'squ_rect',
                                  .default = 'other')),
         materialCat = as.factor(dplyr::recode(na_if(materialCat,""),
                                        .missing = 'Unknown')),
         nfigures = as.factor(dplyr::recode(nfigures,
                                            `0`= 0,
                                            .default = 1))
         ) %>% 
  # change variables into appropriate format
  mutate_at(vars(dealer, origin_author, origin_cat, school_pntg, 
                 diff_origin, artistliving, authorstandard, authorstyle, 
                 winningbiddertype, endbuyer, Interm, type_intermed, 
                 material, mat, materialCat, Shape, engraved, original, 
                 prevcoll, othartist, paired, figures, finished, lrgfont, 
                 relig, landsALL, lands_sc, lands_elem, lands_figs, lands_ment, 
                 arch, mytho, peasant, othgenre, singlefig, portrait, 
                 still_life, discauth, history, allegory, pastorale,other), as.factor) %>% 
  mutate_at(vars(price), as.numeric) 
```

```{r}
paint_train_pre <- paint%>%filter(!is.na(logprice))
eda_test <- cbind(logprice = paint_train_pre$logprice, paint_train_pre[,c(33,39,52)]) %>%
  gather(key = "cat", value = "value", -logprice)
ggplot(eda_test, aes(x = value, y = logprice, colour = cat)) +
  geom_boxplot(show.legend = F) +
  facet_wrap(~cat, scales = "free") +
  labs(x = "", title = "logprice vs categorical predictors") +
  theme_bw()
```

```{r}
# delete unnecessary variables
paint_preselect <- paint %>% 
  dplyr::select(-c("sale", "lot","school_pntg","origin_author","diff_origin", "count","subject", "author", "authorstandard","winningbidder","winningbiddertype","other","pastorale","allegory","history", "lands_ment","original","portrait", "still_life","type_intermed","material","mat","figures","singlefig","Diam_in","Surface_Rnd","Surface_Rect","Width_in","Height_in","price"))

#notice some NAs and 0s in Surface variable, needs to impute them with median
paint_preselect <- paint_preselect%>% mutate(Surface = dplyr::recode(Surface,.missing = median(paint$Surface, na.rm = T)))
paint_preselect$Surface[paint_preselect$Surface==0] <- median(paint$Surface, na.rm = T)

summary(paint_preselect)

paint_train <- paint_preselect%>%filter(!is.na(logprice))
paint_test <-paint_preselect%>%filter(is.na(logprice))

dim(paint_train)
```

For categorical variables: 
 - *sale* includes repetitive information as year and dealer.
 - *lot* has similar information as *position*, while *position* connveys more useful information in terms of %, to control for size of sale.
 - *diff_origin* serves as a predictor indicating whether or not the origin of dealer and author are the same. We believe this predictor should not have influence on auction price so we drop this predictor.
 - *winningbiddertype* is dropped because it is just a more specfic type of *endbuyer*
 - *count* has value of 1 for all data points so we believe this feature has no effect.
 - *author*,*authorstandard*,*subject*, *winningbidder*are categorical data, but they have too many levels, similar information can be achieved from other features with fewer levels.
 - *authorstyle* is regrouped as the ones has information provided and the ones without 
 - *other*,*pastorale*,*allegory*,*history*, *lands_ment*,*original*, *type_intermed*,*still_life*,and *portrait* have serious **class imbalance** problem, where certain value is seldomly observed. So we will discard these variables in modeling.    
 - *mat*, *material* and *materialCat* record duplicate features. We will only keep *materialCat* in future analysis for convenience.  
 - *school_pntg*,*origin_author* and *origin_cat* record similar features which is suspecious of highly dependent on each other. We implement Chi-squared test to test the hypothesis. Thus we will only keep *origin_cat* since it contains less levels. 
 - *nfigures* should be converted to binary data because we have too many 0s and it will be hard to do transformation on it later(can also make reference to the graph)
 - At glance, strong predictors include *dealer*, *discauth*, *endbuyer*, *materialCat*, *interm*, *finished*, *engraved*, *figures*, *Irgfont*, *origin_cat*, *paired*, *portrait*, *prevcoll*, *lands_sc*, *lands_elem*.  
 

For continuous variables: 
 
 - *other* and *position* have most of their values gather around 0 and we cannot observe any obvious pattern.  
 - *Diam-in* and *Surface_Rnd* contain too many NA's and therefore should not be inlcuded in the model.  
 - *Surface* and *Surface_Rect* contain duplicate information, and *Surface* contains all the information in *Surface_Rect*. So we will only keep *Surface*. *Height_in* and *Width_in* are discarded for similar reasoning. Note that I removed rows that *Surface* either is missing or equals 0.
 
- *singlefig*, *figures* and *nfigures* have quite similar information about number of figures related to paintings. According to the above graph, *logprice* seems have more obvious difference with various values of *nfigures*, so dropped the other two.



```{r eda}
hist1 <- ggplot(paint_train, aes(x = logprice)) +
  geom_histogram(fill = "light blue") +
  labs(title = "Empirical distribution for `logprice`")
hist2 <- ggplot(paint_train, aes(x = price)) +
  geom_histogram(fill = "light blue") +
  labs(title = "Empirical distribution for `price`")

# create dataframe for eda plots
eda_cat <- cbind(logprice = paint_train$logprice, 
                 paint_train[, map_chr(paint_train, class) == "factor"])
dim(eda_cat)
eda_con <- paint_train[, map_chr(paint_train, class) == "numeric" |
                         map_chr(paint_train, class) == "integer"] %>% 
  dplyr::select(c(3, 1:4))
eda_cat <- eda_cat %>% 
  gather(key = "categorical", value = "value", -logprice)
eda_con <- eda_con %>% 
  gather(key = "numeric", value  ="value", -logprice)
# split eda_cat since there are too many variables
eda_cat1 <- eda_cat[c(1:19500), ]
eda_cat2 <- eda_cat[c(19501:37500), ]
ggplot(eda_cat1, aes(x = value, y = logprice, colour = categorical)) +
  geom_boxplot(show.legend = F) +
  facet_wrap(~categorical, scales = "free") +
  labs(x = "", title = "logprice vs categorical predictors") +
  theme_bw()
ggplot(eda_cat2, aes(x = value, y = logprice, colour = categorical)) +
  geom_boxplot(show.legend = F) +
  facet_wrap(~categorical, scales = "free") +
  labs(x = "", title = "logprice vs categorical predictors") +
  theme_bw()
ggplot(eda_con, aes(x = value, y = logprice)) +
  geom_point(size = 0.5, alpha = 0.5) +
  stat_smooth(method = "lm") +
  facet_wrap(~numeric, scales = "free") +
  labs(x = "", title = "logprice vs categorical predictors") +
  theme_bw()

ggpairs(paint_train[, map_chr(paint_train, class) == "numeric" |
                         map_chr(paint_train, class) == "integer"] %>% 
  dplyr::select(c(3,1:4)), lower = list(continuous = wrap("points", alpha = 0.5, size = 0.5))) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = "Pairwise Comparisons of Continuous Variables")

```


- from the EDA plot, decided to further drop *othartist*,*mytho*,*relig* and *landsALL*
- Pairwise --> transform *Surface*


```{r}
paint.train_plt_trans <- paint_train[, map_chr(paint_train, class) == "numeric" |
                         map_chr(paint_train, class) == "integer"] %>%
  filter(Surface!=0)%>%
  mutate(Surface = log(Surface)) %>%
  tidyr::gather(key = "variables", value = "values", -logprice)
ggplot(paint.train_plt_trans, aes(x = values, y = logprice))+
geom_point(alpha = 0.5, size = 0.7)+
facet_wrap(~variables, scales = "free_x")+
labs(x = "value", y = "logprice",
title = "logprice vs Transformed Quantitative Predictors") +
theme_linedraw()+
theme(axis.text.x = element_text(angle = 45, hjust = 1))
```




```{r}
paint_train_trans <- paint_train%>% select(-c(othartist,mytho,relig, landsALL))%>%
  mutate(Surface = log(Surface))
dim(paint_train_trans)
model0 <- lm(logprice~(.), data=paint_train_trans)
n = nrow(paint_train_trans)
#use bic to select the variables 
step(model0,k=log(n),trace = F)
#model without interaction
model0.1 <- lm(formula = logprice ~ (dealer + year + origin_cat + artistliving +authorstyle + endbuyer + Interm + Surface + engraved + prevcoll + 
    paired + finished + lrgfont + lands_sc + discauth), data = paint_train_trans)
#prepare for BIC
model2 <- lm(formula = logprice ~ (dealer + year + origin_cat + artistliving +authorstyle + endbuyer + Interm + Surface + engraved + prevcoll + paired + finished + lrgfont + lands_sc + discauth)^2, data = paint_train_trans)
step(model2, k = log(n), trace = F)
#the following model is modified based on BIC selection, I deleted some interactions, feel free to check whether the interaction make sense
model1 <- lm(formula = logprice ~ dealer + year + origin_cat + artistliving + 
                   authorstyle + endbuyer + Interm + Surface + engraved + prevcoll + 
                   paired + finished + lrgfont + lands_sc + discauth + dealer:year + 
                   + dealer:Interm + dealer:discauth + year:artistliving + 
                   year:endbuyer + year:Surface+ year:discauth + 
                   artistliving:authorstyle + artistliving:discauth + 
                   authorstyle:Surface + endbuyer:finished + 
                   endbuyer:discauth + Interm:Surface + Interm:prevcoll + 
                   Interm:lrgfont + Interm:discauth + Surface:discauth + 
                   prevcoll:finished + paired:finished + 
                   paired:lrgfont + paired:discauth, data = paint_train_trans)

lm(formula = logprice ~ dealer + year + origin_cat + artistliving + 
    authorstyle + endbuyer + Interm + Surface + engraved + prevcoll + 
    paired + finished + lrgfont + lands_sc + discauth + dealer:year + 
    dealer:discauth + year:endbuyer + year:discauth + origin_cat:paired + 
    prevcoll:finished + paired:lrgfont, data = paint_train_trans)

model2 <- lm(formula = logprice ~ dealer + year + origin_cat + artistliving + 
    authorstyle + endbuyer + Interm + Surface + engraved + prevcoll + 
    paired + finished + lrgfont + lands_sc + discauth + dealer:year + 
    dealer:discauth + year:endbuyer + year:discauth + 
    prevcoll:finished + paired:lrgfont, data = paint_train_trans)

summary(model2)

```



```{r predict-model2, echo=FALSE}
# replace model1 with model2 here
predictions = as.data.frame(
  exp(predict(model2, newdata=paint_test %>% mutate(Surface = log(Surface)), interval = "pred")))
save(predictions, file="predict-test.Rdata")
```





